<!doctype html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malayalam Template - Space-trigger transliteration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: "Manjari", "Noto Sans Malayalam", system-ui, sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
    }
    .card {
      max-width: 1000px;
      margin: 30px auto;
      background: #fff;
      padding: 25px 30px;
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.06);
    }
    .template {
      white-space: pre-wrap;
      word-break: break-word;
      background: #f1f5f9;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    textarea {
      width: 100%;
      border: 1px solid #cbd5e1;
      padding: 10px;
      border-radius: 8px;
      resize: none;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="text-3xl font-semibold text-indigo-700 mb-2">For Kavya C J CRP</h1>
    <p class="text-gray-600 mb-4">
      Type in <b>Manglish</b>. Each word will convert to Malayalam <b>after you press space</b>. Numbers and acronyms are left unchanged.
    </p>

    <h2 class="text-lg font-semibold mb-2">Malayalam Template</h2>
    <pre id="templatePreview" class="template text-lg">
_________________________ എന്ന ആളുകളുടെ _______________ സർവ്വേ നമ്പറിൽ പെട്ട __ ആർ ___ സ്ക്വേ .മീ സ്ഥലം പരിശോധിച്ചതിൽ ടി സ്ഥലത്തിന്റെ സമീപത്തു നെൽകൃഷി ചെയ്യുന്ന പ്രദേശം ഇല്ല. സ്ഥലത്തു ____ വർഷം പ്രായമുള്ള ___ തെങ്ങ്, സ്ഥലത്തിൻ്റെ വടക്ക് __________, തെക്ക് ____________, കിഴക്കു _____________, പടിഞ്ഞാറ് ____________________. സ്ഥലം 2008 നെൽവയൽ/തണ്ണീർത്തട സംരക്ഷണ നിയമപ്രകാരം നെൽവയൽ/തണ്ണീർത്തടം എന്നിവയുടെ നിർവചനത്തിൽ വരുന്നതല്ല എന്ന് അനുമാനിക്കാവുന്നതാണ്. ആയതിനാൽ മേൽപ്പറഞ്ഞ സ്ഥലം ഡാറ്റ ബാങ്കിൽ നിന്നും ഒഴിവാക്കാവുന്നതാണ്.
    </pre>

    <h2 class="text-lg font-semibold mt-6 mb-2">Fill the blanks (in Manglish)</h2>
    <div id="inputsArea" class="space-y-3"></div>

    <div class="flex gap-2 mt-4">
      <button id="copyBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Copy</button>
      <button id="downloadBtn" class="px-4 py-2 border border-indigo-600 text-indigo-600 rounded">Download</button>
      <button id="resetBtn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded">Reset</button>
    </div>

    <h2 class="text-lg font-semibold mt-6 mb-2">Final Malayalam Sentence</h2>
    <div id="finalOutput" class="rounded p-4 bg-gray-50 border border-gray-200 min-h-[200px] text-lg"></div>
  </div>

<script>
const template = document.getElementById("templatePreview").textContent;
const blanks = [...template.matchAll(/_+/g)];
const inputsArea = document.getElementById("inputsArea");
const finalOutput = document.getElementById("finalOutput");

/* Create input fields dynamically */
blanks.forEach((b, i) => {
  const div = document.createElement("div");
  div.innerHTML = `
    <label class="block text-sm text-gray-600 mb-1">Blank ${i + 1}</label>
    <textarea id="input_${i}" rows="1" placeholder="Type in Manglish and press space..."></textarea>
  `;
  inputsArea.appendChild(div);
});

/* Add handler that transliterates the word before the cursor when a space is typed */
document.querySelectorAll("textarea").forEach(t => {
  t.addEventListener("keydown", async (e) => {
    // We handle space on keydown so we can inspect caret position before the space is added
    if (e.key === " " || e.code === "Space") {
      // prevent default temporarily so we control insertion after replacement
      e.preventDefault();

      const textarea = e.target;
      const cursorPos = textarea.selectionStart; // position where space would be inserted
      const before = textarea.value.slice(0, cursorPos);
      const after = textarea.value.slice(cursorPos);

      // find the last contiguous non-space sequence (the word) before cursor
      const m = before.match(/(\S+)\s*$/);
      if (!m) {
        // if no word, just insert a space
        const newVal = before + " " + after;
        textarea.value = newVal;
        setCaret(textarea, cursorPos + 1);
        updateOutput();
        return;
      }

      const lastWord = m[1];

      // Skip transliteration if it contains digits (numbers) or is all-caps acronyms
      if (/\d/.test(lastWord) || /^[A-Z0-9]+$/.test(lastWord)) {
        // insert space after the word as-is
        const startIndex = cursorPos - lastWord.length;
        const newVal = textarea.value.slice(0, startIndex + lastWord.length) + " " + after;
        textarea.value = newVal;
        setCaret(textarea, startIndex + lastWord.length + 1);
        updateOutput();
        return;
      }

      // Transliterate only the single lastWord
      const mal = await transliterateWord(lastWord);
      const startIndex = cursorPos - lastWord.length;
      const newVal = textarea.value.slice(0, startIndex) + mal + " " + after;
      textarea.value = newVal;

      // place caret after the inserted space
      setCaret(textarea, startIndex + mal.length + 1);
      updateOutput();
    }
  });

  // also update final output on normal input (typing, backspace etc.)
  t.addEventListener("input", () => updateOutput());
});

/* Helper to set caret position */
function setCaret(el, pos) {
  el.focus();
  try {
    el.setSelectionRange(pos, pos);
  } catch (err) {
    // ignore if not supported
  }
}

/* Transliteration via Google Input Tools API (single-word) */
async function transliterateWord(word) {
  try {
    const url = `https://inputtools.google.com/request?text=${encodeURIComponent(word)}&itc=ml-t-i0-und&num=1&ie=utf-8&oe=utf-8`;
    const res = await fetch(url);
    const data = await res.json();
    if (Array.isArray(data) && data[0] === "SUCCESS" && data[1] && data[1][0] && data[1][0][1] && data[1][0][1][0]) {
      return data[1][0][1][0];
    }
  } catch (err) {
    console.error("Transliteration error:", err);
  }
  // fallback: return original word
  return word;
}

/* Update the final output sentence */
function updateOutput() {
  let out = template;
  inputsArea.querySelectorAll("textarea").forEach(input => {
    out = out.replace(/_+/, input.value.trim());
  });
  finalOutput.textContent = out;
}

/* Copy / Download / Reset */
document.getElementById("copyBtn").onclick = async () => {
  const text = finalOutput.textContent.trim();
  if (!text) return alert("No text to copy.");
  await navigator.clipboard.writeText(text);
  alert("Copied ✅");
};

document.getElementById("downloadBtn").onclick = () => {
  const text = finalOutput.textContent.trim();
  if (!text) return alert("No text to download.");
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Malayalam_Converted.txt";
  a.click();
};

document.getElementById("resetBtn").onclick = () => {
  document.querySelectorAll("textarea").forEach(t => t.value = "");
  finalOutput.textContent = "";
};
</script>
</body>
</html>