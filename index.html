<!doctype html>
<html lang="ml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malayalam Template - Downloadable DOCX</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Add docx.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.1/docx.umd.min.js"></script>
  <style>
    body {
      font-family: "Manjari", "Noto Sans Malayalam", system-ui, sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
    }
    .card {
      max-width: 1000px;
      margin: 30px auto;
      background: #fff;
      padding: 25px 30px;
      border-radius: 16px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.06);
    }
    textarea {
      width: 100%;
      border: 1px solid #cbd5e1;
      padding: 10px;
      border-radius: 8px;
      resize: none;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="text-2xl font-semibold text-indigo-700 mb-2">For Kavya C J CRP</h1>
    <p class="text-gray-600 mb-4">Type in Manglish — auto transliteration to Malayalam after 3 seconds or when you press space. Numbers remain unchanged.</p>

    <pre id="templatePreview" class="bg-gray-50 border p-3 rounded mb-3">
_________________________ എന്ന ആളുകളുടെ _______________ സർവ്വേ നമ്പറിൽ പെട്ട __ ആർ ___ സ്ക്വേ .മീ സ്ഥലം പരിശോധിച്ചതിൽ ടി സ്ഥലത്തിന്റെ സമീപത്തു നെൽകൃഷി ചെയ്യുന്ന പ്രദേശം ഇല്ല. സ്ഥലത്തു ____ വർഷം പ്രായമുള്ള ___ തെങ്ങ്, സ്ഥലത്തിൻ്റെ വടക്ക് __________, തെക്ക് ____________, കിഴക്കു _____________, പടിഞ്ഞാറ് ____________________. സ്ഥലം 2008 നെൽവയൽ/തണ്ണീർത്തട സംരക്ഷണ നിയമപ്രകാരം നെൽവയൽ/തണ്ണീർത്തടം എന്നിവയുടെ നിർവചനത്തിൽ വരുന്നതല്ല എന്ന് അനുമാനിക്കാവുന്നതാണ്. ആയതിനാൽ മേൽപ്പറഞ്ഞ സ്ഥലം ഡാറ്റ ബാങ്കിൽ നിന്നും ഒഴിവാക്കാവുന്നതാണ്.
    </pre>

    <div id="inputsArea" class="space-y-4"></div>

    <div class="flex gap-2 mt-6">
      <button id="downloadBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Download DOCX</button>
    </div>

    <h2 class="text-lg font-semibold mt-6 mb-2">Final Malayalam Sentence</h2>
    <div id="finalOutput" class="rounded p-4 bg-gray-50 border border-gray-200 min-h-[200px] text-lg"></div>
  </div>

<script>
const template = document.getElementById("templatePreview").textContent;
const blanks = [...template.matchAll(/_+/g)];
const inputsArea = document.getElementById("inputsArea");
const finalOutput = document.getElementById("finalOutput");

const blankLabels = [
  "Name",
  "Survey Number",
  "Aar",
  "Sq. Mtr",
  "Varsham Prayam",
  "Coconut No",
  "North",
  "South",
  "East",
  "West"
];

blanks.forEach((b, i) => {
  const div = document.createElement("div");
  div.innerHTML = `
    <label class="block text-sm text-gray-700 mb-1">${blankLabels[i] || `Blank ${i+1}`}</label>
    <textarea id="input_${i}" rows="1" placeholder="Type in Manglish..."></textarea>
  `;
  inputsArea.appendChild(div);
});

document.querySelectorAll("textarea").forEach((t, i) => {
  let timeout;
  t.addEventListener("input", (e) => {
    clearTimeout(timeout);
    if (e.data === " ") transliterateLastWord(t, i);
    timeout = setTimeout(() => transliterateLastWord(t, i), 3000);
  });
});

async function transliterateLastWord(field, index) {
  const text = field.value;
  const words = text.split(/\s+/);
  const lastWord = words[words.length - 1];
  if (!lastWord || /^[0-9.,+-/]+$/.test(lastWord)) return updateOutput();
  const url = `https://inputtools.google.com/request?text=${encodeURIComponent(lastWord)}&itc=ml-t-i0-und&num=1`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data[0] === "SUCCESS" && data[1]?.[0]?.[1]?.[0]) {
      words[words.length - 1] = data[1][0][1][0];
      field.value = words.join(" ");
    }
    updateOutput();
  } catch (e) { console.error(e); }
}

function updateOutput() {
  let out = template;
  inputsArea.querySelectorAll("textarea").forEach(t => out = out.replace(/_+/, t.value.trim()));
  finalOutput.textContent = out;
}

document.getElementById("downloadBtn").onclick = async () => {
  const text = finalOutput.textContent.trim();
  if (!text) return alert("No text to download.");

  const { Document, Packer, Paragraph, TextRun } = window.docx;

  const doc = new Document({
    sections: [{
      properties: {},
      children: [new Paragraph({
        children: [new TextRun({ text, font: "Noto Sans Malayalam", size: 24 })],
      })],
    }],
  });

  const blob = await Packer.toBlob(doc);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Malayalam_Converted.docx";
  a.click();
};
</script>
</body>
</html>